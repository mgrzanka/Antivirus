import sqlite3
import os
import requests


def check_by_executable(file_path):
    return os.access(file_path, os.X_OK)


def check_by_MD5(file_hash: str):  # Checking file by MD5 hash
    db_path = "C:\\Users\\Gosia\\Downloads\\HashDB (1)"
    hashes_db = sqlite3.connect(db_path)
    db_cur = hashes_db.cursor()
    result = db_cur.execute("SELECT * FROM HashDB WHERE hash=?", (file_hash,))
    result = result.fetchall()
    if result:
        return result
    else:
        return None


def check_by_API(file_path, api_key):
    def upload_file(file_path, api_key):
        url = "https://www.virustotal.com/api/v3/files"
        headers = {
            'x-apikey': api_key
        }
        with open(file_path, 'rb') as file:
            files = {'file': (file_path, file)}
            response = requests.post(url, files=files, headers=headers)
            result = response.json()
        if 'data' in result:
            return result['data']['links']['self']
        else:
            return None
    # Get file report
    url = upload_file(file_path, api_key)
    headers = {
        'x-apikey': api_key
    }
    response = requests.get(url, headers=headers)
    result = response.json()
    path = result['data']['attributes']['stats']
    all = path['harmless'] + path["type-unsupported"] + path["suspicious"]
    all += + path["malicious"] + path["undetected"]
    if all > 0:
        return path["malicious"]/all > 0.5
    else:
        return False
